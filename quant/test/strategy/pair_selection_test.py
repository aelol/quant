# coding =utf-8
# ae_h - 2018/6/4
import os
import sys

CURRENT_DIR = os.path.abspath(os.path.dirname(__file__))
ROOT_DIR = os.path.dirname(os.path.dirname(CURRENT_DIR))
sys.path.append(ROOT_DIR)

import unittest

from quant.test import before_run
from quant.strategy.pair.pair_selection import code_muning, cal_pair_stocks, cal_p_value
import tushare as ts
from quant.dao.k_data.k_data_tech_feature_dao import k_data_tech_feature_dao
from quant.common_tools.datetime_utils import get_next_date


class PairStrategyTest(unittest.TestCase):
    def setUp(self):
        before_run()

    def test_strategy(self):
        data = ts.get_sz50s()
        code_set = code_muning(data)
        cal_pair_stocks(code_set)

    def test_cal_p_value(self):
        pair_set = set()
        pair_set.add(('600519', '000858'))
        cal_pair_stocks(pair_set)

    def test_filter_result(self):
        list = [['000792', '002601'], ['600015', '601818'], ['000568', '000858'], ['000728', '002736'],
                ['601088', '601225'], ['600406', '601877'], ['002500', '002736'], ['000538', '002294'],
                ['000402', '600340'], ['000783', '600837'], ['000723', '000983'], ['000538', '600518'],
                ['600170', '601390'], ['000768', '600372'], ['000709', '000898'], ['002475', '600703'],
                ['600372', '600893'], ['000538', '300122'], ['601166', '601328'], ['002736', '601099'],
                ['002736', '600837'], ['600795', '600886'], ['000069', '000671'], ['002736', '601788'],
                ['601818', '601998'], ['600688', '601857'], ['002007', '600518'], ['600085', '600518'],
                ['000060', '000630'], ['601328', '601998'], ['002736', '600109'], ['600518', '601607'],
                ['600583', '600688'], ['600170', '601618'], ['002065', '300033'], ['000728', '000783'],
                ['000728', '601901'], ['300122', '600436'], ['002736', '601377'], ['600109', '601099'],
                ['000568', '600519'], ['601006', '601333'], ['600177', '600376'], ['600208', '600383'],
                ['000728', '601377'], ['000783', '002500'], ['000839', '002555'], ['601099', '601555'],
                ['002736', '600369'], ['000625', '600297'], ['000625', '002594'], ['600068', '601800'],
                ['000538', '300015'], ['002153', '600271'], ['601018', '601919'], ['300122', '600276'],
                ['601186', '601669'], ['600219', '600362'], ['002294', '600085'], ['000069', '000540'],
                ['000709', '600010'], ['000423', '600518'], ['600170', '601669'], ['600118', '600372'],
                ['600376', '600663'], ['000792', '002466'], ['000792', '600352'], ['000728', '600837'],
                ['000069', '002146'], ['000402', '600177'], ['000768', '600893'], ['000776', '601688'],
                ['300024', '600482'], ['600115', '601111'], ['600340', '600383'], ['000728', '601099'],
                ['000963', '600518'], ['002294', '600518'], ['002294', '300015'], ['601818', '601988'],
                ['000858', '600519'], ['000725', '002475'], ['300017', '300033'], ['600170', '601186'],
                ['600015', '601998'], ['600820', '601618'], ['600415', '600739'], ['000540', '000671'],
                ['000671', '600383'], ['000826', '300070'], ['002736', '601555'], ['600820', '601186'],
                ['601328', '601988'], ['000776', '002736'], ['600109', '601555'], ['300033', '600271'],
                ['000623', '600518'], ['000538', '000963'], ['000623', '601607'], ['000623', '600535'],
                ['000725', '600703'], ['002252', '600085'], ['000540', '600208'], ['601186', '601618'],
                ['600118', '600893'], ['600177', '600208'], ['600208', '600376'], ['000783', '002736'],
                ['002146', '600340'], ['600177', '600663'], ['000060', '601958'], ['600271', '600570'],
                ['000671', '600208'], ['000728', '601555'], ['600023', '600886'], ['000060', '600111'],
                ['600196', '600518'], ['000402', '600663'], ['000402', '000961'], ['000402', '000540'],
                ['002153', '300033'],
                ['600029', '601111']]

        for item in list:
            code1 = item[0]
            code2 = item[1]
            stock1_tech = k_data_tech_feature_dao.get_k_data(code1, get_next_date(-1), get_next_date(-1))
            stock2_tech = k_data_tech_feature_dao.get_k_data(code2, get_next_date(-1), get_next_date(-1))

            stock1 = ts.get_realtime_quotes(code1)
            stock2 = ts.get_realtime_quotes(code2)

            price1 = float(stock1['price'].values[0])
            price2 = float(stock2['price'].values[0])

            if len(stock1_tech['ma20'].values) <= 0 or len(stock2_tech['ma20'].values) <= 0:
                continue

            if price1 > stock1_tech['ma20'].values[0] and price2 > stock2_tech['ma20'].values[0]:
                print(code1, code2)
